<!DOCTYPE html>
<html>
<head>
  <title>Option Pricer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    .model-param { display: none; }
  </style>
</head>
<body>
  <h2>Option Pricer</h2>

  <form id="optionForm">
    <label>Stock Price (S):</label>
    <input type="number" id="S" value="100" step="1" required><br>

    <label>Strike Price (K):</label>
    <input type="number" id="K" value="100" step="1" required><br>

    <label>Time to Maturity (T in years):</label>
    <input type="number" id="T" value="1" step="0.1" required><br>

    <label>Risk-Free Rate (r):</label>
    <input type="number" id="r" value="0.05" step="0.01" required><br>

    <label>Volatility (Ïƒ):</label>
    <input type="number" id="sigma" value="0.2" step="0.01" required><br>

    <label>Option Type:</label>
    <select id="option_type">
      <option value="call">Call</option>
      <option value="put">Put</option>
    </select><br>

    <label>Model:</label>
    <select id="model">
      <option value="black_scholes">Black-Scholes</option>
      <option value="binomial">Binomial</option>
      <option value="monte_carlo">Monte Carlo</option>
      <option value="pde">PDE (Crank-Nicolson)</option>
    </select><br><br>

    <!-- Extra Inputs (Hidden by default) -->

    <div id="n_steps_container" class="model-param">
      <label>Tree/Time Steps (n_steps):</label>
      <input type="number" id="n_steps" value="100" step="10"><br>
    </div>

    <div id="n_simulations_container" class="model-param">
      <label>Simulations (n_simulations):</label>
      <input type="number" id="n_simulations" value="10000" step="1000"><br>
    </div>

    <div id="x_max_container" class="model-param">
      <label>Max Asset Price Domain (x_max):</label>
      <input type="number" id="x_max" value="3" step="0.1"><br>
    </div>

    <div id="n_t_container" class="model-param">
      <label>PDE Time Steps (n_t):</label>
      <input type="number" id="n_t" value="1000" step="100"><br>
    </div>
    <label>Exercise Style:</label>
    <select id="exercise_style">
        <option value="european">European</option>
        <option value="american">American</option>
    </select><br>

    <button type="submit">Get Price & Plot</button>
  </form>

  <div id="plot"></div>
  <p id="output"></p>

  <script>
    const modelParamMap = {
      black_scholes: [],
      binomial: ["n_steps"],
      monte_carlo: ["n_steps", "n_simulations"],
      pde: ["x_max", "n_t"]
    };

    // ...existing code...
    function updateVisibleInputs() {
        const selectedModel = document.getElementById("model").value;
        const allFields = ["n_steps", "n_simulations", "x_max", "n_t"];
        const exerciseStyleSelect = document.getElementById("exercise_style");
        const americanOption = exerciseStyleSelect.querySelector('option[value="american"]');
  
        allFields.forEach(field => {
          const el = document.getElementById(`${field}_container`);
          if (modelParamMap[selectedModel].includes(field)) {
            el.style.display = "block";
          } else {
            el.style.display = "none";
          }
        });
  
        // Hide American option for Black-Scholes
        if (selectedModel === "black_scholes") {
          americanOption.style.display = "none";
          // If American was selected, switch to European
          if (exerciseStyleSelect.value === "american") {
            exerciseStyleSelect.value = "european";
          }
        } else {
          americanOption.style.display = ""; // Show American option for other models
        }
      }
  
      document.getElementById("model").addEventListener("change", updateVisibleInputs);
      window.addEventListener("DOMContentLoaded", updateVisibleInputs);
  
      document.getElementById("optionForm").addEventListener("submit", async (e) => {
        e.preventDefault();
  
        const payload = {
            S: parseFloat(document.getElementById("S").value),
            K: parseFloat(document.getElementById("K").value),
            T: parseFloat(document.getElementById("T").value),
            r: parseFloat(document.getElementById("r").value),
            sigma: parseFloat(document.getElementById("sigma").value),
            option_type: document.getElementById("option_type").value,
            model: document.getElementById("model").value,
            american = (styleDropdown && styleDropdown.value === "american");
          };

      if (document.getElementById("n_steps_container").style.display !== "none")
        payload.n_steps = parseInt(document.getElementById("n_steps").value);

      if (document.getElementById("n_simulations_container").style.display !== "none")
        payload.n_simulations = parseInt(document.getElementById("n_simulations").value);

      if (document.getElementById("x_max_container").style.display !== "none")
        payload.x_max = parseFloat(document.getElementById("x_max").value);

      if (document.getElementById("n_t_container").style.display !== "none")
        payload.n_t = parseInt(document.getElementById("n_t").value);

      try {
        const res = await fetch("/plot", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await res.json();

        if (result.error) {
          document.getElementById("output").innerText = `Error: ${result.error}`;
          Plotly.purge("plot");
          return;
        }

        const plot = JSON.parse(result.plot);
        Plotly.newPlot("plot", plot.data, plot.layout);

        if (result.price !== undefined) {
          document.getElementById("output").innerText = `Price: $${result.price.toFixed(4)}`;
        }

      } catch (err) {
        document.getElementById("output").innerText = "Failed to fetch plot.";
        console.error(err);
      }
    });
  </script>
</body>
</html>
